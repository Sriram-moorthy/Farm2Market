<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Farm2Market</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåæ</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="logo">Farm2Market</a>
                <ul class="nav-links">
                    <li><a href="/buyer-dashboard?user_id={{ user.id }}">Dashboard</a></li>
                    <li><a href="#" id="buyerName">{{ user.full_name }}</a></li>
                    <li><a href="/">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Cart Header -->
            <div class="dashboard">
                <div class="dashboard-header">
                    <h1>üõí Your Shopping Cart</h1>
                    <p>Review your selected crops before checkout</p>
                </div>
                
                <div class="dashboard-content">
                    {% if cart_items %}
                        <!-- Cart Items -->
                        <div class="modern-cart-items">
                            {% for item in cart_items %}
                                <div class="modern-cart-item">
                                    <div class="cart-item-image">
                                        {% if item.crop.image_url %}
                                            <img src="{{ item.crop.image_url }}" alt="{{ item.crop.name }}" loading="lazy">
                                        {% else %}
                                            <div class="image-placeholder">
                                                <span>üåæ</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="cart-item-info">
                                        <h3 class="item-name">{{ item.crop.name|title }}</h3>
                                        <p class="item-farmer">
                                            <span class="label">Farmer:</span> 
                                            <a href="/profile/{{ item.crop.farmer_id }}?current_user_id={{ user.id }}" class="farmer-link">
                                                {{ users.get(item.crop.farmer_id, {}).get('full_name', 'Unknown') }}
                                            </a>
                                        </p>
                                        <p class="item-location">
                                            <span class="label">üìç</span> {{ item.crop.location }}
                                        </p>
                                        <p class="item-unit-price">
                                            <span class="label">Unit Price:</span> ‚Çπ{{ item.crop.price }}/{{ item.crop.unit }}
                                        </p>
                                    </div>
                                    
                                    <div class="cart-item-quantity">
                                        <label class="quantity-label">Quantity</label>
                                        <div class="quantity-controls">
                                            <button class="qty-btn" onclick="updateQuantity('{{ item.cart_item.crop_id }}', -1)">-</button>
                                            <input type="number" 
                                                   value="{{ item.cart_item.quantity }}" 
                                                   min="0.1" 
                                                   step="0.1" 
                                                   class="quantity-input"
                                                   onchange="updateCartQuantity('{{ item.cart_item.crop_id }}', this.value)">
                                            <button class="qty-btn" onclick="updateQuantity('{{ item.cart_item.crop_id }}', 1)">+</button>
                                        </div>
                                        <small class="unit-text">{{ item.crop.unit }}</small>
                                    </div>
                                    
                                    <div class="cart-item-total">
                                        <div class="item-total-price">‚Çπ{{ "%.2f"|format(item.item_total) }}</div>
                                        <button class="remove-btn" onclick="removeFromCart('{{ item.cart_item.crop_id }}')">
                                            üóëÔ∏è Remove
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Enhanced Checkout Section -->
                        <div class="checkout-container">
                            <!-- Delivery Options -->
                            <div class="checkout-section">
                                <h3 class="section-title">üöö Delivery Options</h3>
                                <div class="delivery-options">
                                    <label class="option-card">
                                        <input type="radio" name="delivery" value="farmer" checked>
                                        <div class="option-content">
                                            <div class="option-icon">üöú</div>
                                            <div class="option-info">
                                                <h4>Direct delivery from farmer</h4>
                                                <p>Recommended ‚Ä¢ Fresh from farm</p>
                                            </div>
                                            <div class="option-price">Free</div>
                                        </div>
                                    </label>
                                    <label class="option-card">
                                        <input type="radio" name="delivery" value="partner">
                                        <div class="option-content">
                                            <div class="option-icon">üöö</div>
                                            <div class="option-info">
                                                <h4>Delivery partner service</h4>
                                                <p>Professional delivery ‚Ä¢ Insurance covered</p>
                                            </div>
                                            <div class="option-price">+‚Çπ50</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Payment Options -->
                            <div class="checkout-section">
                                <h3 class="section-title">üí≥ Payment Method</h3>
                                <div class="payment-options">
                                    <label class="option-card">
                                        <input type="radio" name="payment" value="razorpay" checked>
                                        <div class="option-content">
                                            <div class="option-icon">üí≥</div>
                                            <div class="option-info">
                                                <h4>Credit/Debit Card (Razorpay)</h4>
                                                <p>Secure online payment</p>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="option-card">
                                        <input type="radio" name="payment" value="upi">
                                        <div class="option-content">
                                            <div class="option-icon">üì±</div>
                                            <div class="option-info">
                                                <h4>UPI Payment</h4>
                                                <p>PhonePe, Google Pay, Paytm</p>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="option-card">
                                        <input type="radio" name="payment" value="cod">
                                        <div class="option-content">
                                            <div class="option-icon">üíµ</div>
                                            <div class="option-info">
                                                <h4>Cash on Delivery</h4>
                                                <p>Pay when you receive</p>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Order Summary -->
                            <div class="order-summary">
                                <h3 class="section-title">üìã Order Summary</h3>
                                <div class="summary-breakdown">
                                    <div class="summary-line">
                                        <span>Subtotal ({{ cart_items|length }} items)</span>
                                        <span>‚Çπ{{ "%.2f"|format(total_price) }}</span>
                                    </div>
                                    <div class="summary-line">
                                        <span>Delivery Fee</span>
                                        <span id="deliveryFee">‚Çπ0.00</span>
                                    </div>
                                    <div class="summary-line">
                                        <span>Platform Fee (2%)</span>
                                        <span>‚Çπ{{ "%.2f"|format(total_price * 0.02) }}</span>
                                    </div>
                                    <div class="summary-divider"></div>
                                    <div class="summary-total">
                                        <span>Total Amount</span>
                                        <span id="finalTotal">‚Çπ{{ "%.2f"|format(total_price * 1.02) }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Checkout Button -->
                            <form id="checkoutForm" action="/checkout" method="POST">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <button type="button" class="checkout-btn" onclick="processCheckout()">
                                    <span class="btn-icon">üõí</span>
                                    <span class="btn-text">Proceed to Checkout</span>
                                    <span class="btn-amount" id="checkoutAmount">‚Çπ{{ "%.2f"|format(total_price * 1.02) }}</span>
                                </button>
                            </form>
                        </div>
                        
                    {% else %}
                        <!-- Empty Cart -->
                        <div class="text-center" style="padding: 4rem;">
                            <h2>üõí Your cart is empty</h2>
                            <p style="margin: 2rem 0;">Start shopping for fresh crops from local farmers!</p>
                            <a href="/buyer-dashboard?user_id={{ user.id }}" class="btn" style="font-size: 1.2rem;">
                                üå± Browse Crops
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    <!-- Order Confirmation Modal -->
    <div id="orderConfirmationModal" class="order-confirmation" style="display: none;">
        <div class="confirmation-content">
            <div class="confirmation-icon">üéâ</div>
            <h2 class="confirmation-title">Order Placed Successfully!</h2>
            <p class="confirmation-message">
                Thank you for your order! Your fresh crops are being prepared by our trusted farmers. 
                You will receive updates via SMS and email.
            </p>
            <div class="confirmation-details">
                <p><strong>Order ID:</strong> <span id="orderId">#FM-001</span></p>
                <p><strong>Estimated Delivery:</strong> <span id="deliveryDate">2-3 days</span></p>
            </div>
            <button class="btn btn-primary" onclick="closeOrderConfirmation()" style="margin-top: 1.5rem; padding: 1rem 2rem;">
                Continue Shopping
            </button>
        </div>
    </div>

    <!-- Recommended Products -->
    {% if cart_items %}
    <section style="padding: 4rem 0; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <h2 style="text-align: center; color: white; margin-bottom: 3rem;">
                üåü You might also like
            </h2>
            <div class="grid grid-3">
                <div class="card">
                    <div style="height: 150px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <span style="color: #666;">ü•ï Carrots</span>
                    </div>
                    <h3>Fresh Carrots</h3>
                    <p>5 kg available</p>
                    <div class="price">‚Çπ45/kg</div>
                </div>
                <div class="card">
                    <div style="height: 150px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <span style="color: #666;">ü•¨ Cabbage</span>
                    </div>
                    <h3>Organic Cabbage</h3>
                    <p>10 kg available</p>
                    <div class="price">‚Çπ25/kg</div>
                </div>
                <div class="card">
                    <div style="height: 150px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <span style="color: #666;">üåæ Wheat</span>
                    </div>
                    <h3>Premium Wheat</h3>
                    <p>50 kg available</p>
                    <div class="price">‚Çπ30/kg</div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- AI Assistant Toggle Button -->
    <button class="ai-assistant-toggle" id="aiToggle" title="Chat with AI Assistant">ü§ñ</button>

    <!-- AI Assistant Panel -->
    <div class="ai-assistant-panel" id="aiPanel">
        <div class="ai-assistant-header">
            <div>
                <h3>ü§ñ Farm2Market AI Assistant</h3>
                <small>Powered by Gemini AI</small>
            </div>
            <button class="ai-assistant-minimize" id="aiMinimize">√ó</button>
        </div>
        <div class="ai-assistant-messages" id="aiMessages">
            <!-- Messages will be added here -->
        </div>
        <div class="ai-assistant-input">
            <input type="text" id="aiInput" placeholder="Ask me anything about farming or our platform..." maxlength="500">
            <button class="ai-assistant-send" id="aiSend">üì§</button>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        function updateQuantity(cropId, change) {
            const input = document.querySelector(`input[onchange*="${cropId}"]`);
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(1, currentValue + change);
            input.value = newValue;
            updateCartQuantity(cropId, newValue);
        }
        
        function updateCartQuantity(cropId, quantity) {
            if (quantity < 1) {
                quantity = 1;
                const input = document.querySelector(`input[onchange*="${cropId}"]`);
                input.value = quantity;
            }
            
            // Update the item total price for this specific crop
            updateItemTotal(cropId, quantity);
            
            // In a real app, this would make an API call to update the cart
            farm2market.showNotification('success', `Updated quantity to ${quantity}`);
            
            // Recalculate all totals
            updateTotals();
        }
        
        function updateItemTotal(cropId, quantity) {
            // Find the cart item container
            const cartItem = document.querySelector(`input[onchange*="${cropId}"]`).closest('.modern-cart-item');
            
            // Get the unit price from the item info
            const unitPriceText = cartItem.querySelector('.item-unit-price').textContent;
            const unitPrice = parseFloat(unitPriceText.match(/‚Çπ([\d.]+)/)[1]);
            
            // Calculate new total
            const newTotal = unitPrice * quantity;
            
            // Update the displayed total
            const totalPriceElement = cartItem.querySelector('.item-total-price');
            totalPriceElement.textContent = `‚Çπ${newTotal.toFixed(2)}`;
        }
        
        function removeFromCart(cropId) {
            if (confirm('Remove this item from your cart?')) {
                // Get user ID from URL params
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('user_id');
                
                // Make API call to remove item from cart
                fetch(`/api/cart/remove/${cropId}?user_id=${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        farm2market.showNotification('success', 'Item removed from cart');
                        // Remove the cart item element
                        const cartItem = document.querySelector(`input[onchange*="${cropId}"]`).closest('.modern-cart-item');
                        if (cartItem) {
                            cartItem.remove();
                        }
                        updateTotals();
                        
                        // If cart is empty, redirect or show empty state
                        if (document.querySelectorAll('.modern-cart-item').length === 0) {
                            location.reload();
                        }
                    } else {
                        farm2market.showNotification('error', data.message || 'Failed to remove item');
                    }
                })
                .catch(error => {
                    console.error('Error removing item:', error);
                    farm2market.showNotification('error', 'Failed to remove item');
                });
            }
        }
        
        function updateTotals() {
            // Recalculate totals based on current cart items
            let subtotal = 0;
            document.querySelectorAll('.modern-cart-item').forEach(item => {
                const priceElement = item.querySelector('.item-total-price');
                const price = parseFloat(priceElement.textContent.replace('‚Çπ', ''));
                subtotal += price;
            });
            
            // Get delivery fee based on selected option
            const deliveryRadio = document.querySelector('input[name="delivery"]:checked');
            const deliveryFee = deliveryRadio && deliveryRadio.value === 'partner' ? 50 : 0;
            
            // Calculate platform fee (2% of subtotal)
            const platformFee = subtotal * 0.02;
            
            // Calculate final total
            const total = subtotal + deliveryFee + platformFee;
            
            // Update all displayed totals
            const subtotalElements = document.querySelectorAll('.summary-line span');
            if (subtotalElements.length >= 2) {
                subtotalElements[1].textContent = `‚Çπ${subtotal.toFixed(2)}`;
            }
            
            document.getElementById('deliveryFee').textContent = `‚Çπ${deliveryFee.toFixed(2)}`;
            
            const platformFeeElements = document.querySelectorAll('.summary-line');
            if (platformFeeElements.length >= 3) {
                const platformFeeSpans = platformFeeElements[2].querySelectorAll('span');
                if (platformFeeSpans.length >= 2) {
                    platformFeeSpans[1].textContent = `‚Çπ${platformFee.toFixed(2)}`;
                }
            }
            
            document.getElementById('finalTotal').textContent = `‚Çπ${total.toFixed(2)}`;
            
            // Update checkout button amount
            const checkoutAmount = document.getElementById('checkoutAmount');
            if (checkoutAmount) {
                checkoutAmount.textContent = `‚Çπ${total.toFixed(2)}`;
            }
        }
        
        function processCheckout() {
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked').value;
            const finalTotal = parseFloat(document.getElementById('finalTotal').textContent.replace('‚Çπ', ''));
            
            // Disable checkout button to prevent double-submission
            const checkoutBtn = document.querySelector('.checkout-btn');
            checkoutBtn.disabled = true;
            checkoutBtn.innerHTML = '<span class="btn-text">Processing...</span>';
            
            if (paymentMethod === 'razorpay') {
                // Simulate Razorpay payment
                farm2market.showNotification('info', 'Redirecting to payment gateway...');
                setTimeout(() => {
                    handlePayment(finalTotal, paymentMethod);
                }, 1500);
            } else if (paymentMethod === 'upi') {
                // Simulate UPI payment
                farm2market.showNotification('info', 'Redirecting to UPI app...');
                setTimeout(() => {
                    handlePayment(finalTotal, paymentMethod);
                }, 2000);
            } else {
                // Cash on delivery
                farm2market.showNotification('info', 'Processing your order...');
                setTimeout(() => {
                    handlePayment(finalTotal, paymentMethod);
                }, 1000);
            }
        }
        
        function handlePayment(amount, method) {
            // Simulate payment success and show order confirmation
            showOrderConfirmation(amount, method);
        }
        
        function showOrderConfirmation(amount, paymentMethod) {
            // Generate order ID
            const orderId = 'FM-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Calculate delivery date
            const deliveryDate = new Date();
            deliveryDate.setDate(deliveryDate.getDate() + 3);
            const deliveryDateStr = deliveryDate.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Update modal content
            document.getElementById('orderId').textContent = orderId;
            document.getElementById('deliveryDate').textContent = deliveryDateStr;
            
            // Show confirmation modal
            document.getElementById('orderConfirmationModal').style.display = 'flex';
            
            // Add celebration effect
            setTimeout(() => {
                createConfetti();
            }, 300);
            
            // Auto-close after 5 seconds and submit form
            setTimeout(() => {
                // Submit the form to actually process the order
                document.getElementById('checkoutForm').submit();
            }, 5000);
        }
        
        function closeOrderConfirmation() {
            document.getElementById('orderConfirmationModal').style.display = 'none';
            // Submit the form to process the order
            document.getElementById('checkoutForm').submit();
        }
        
        function createConfetti() {
            // Simple confetti effect
            const colors = ['#4CAF50', '#66BB6A', '#81C784', '#A5D6A7'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.zIndex = '9999';
                confetti.style.borderRadius = '50%';
                confetti.style.pointerEvents = 'none';
                confetti.style.animation = `fall ${2 + Math.random() * 3}s linear infinite`;
                
                document.body.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Update totals when delivery method changes
        document.querySelectorAll('input[name="delivery"]').forEach(radio => {
            radio.addEventListener('change', updateTotals);
        });
        
        // Initialize totals on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTotals();
        });
        
        // Continue shopping button
        function continueShopping() {
            window.location.href = '/buyer-dashboard?user_id={{ user.id }}';
        }
    </script>
</body>
</html> 